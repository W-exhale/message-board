<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ç•™è¨€æ¿</title>
    <style>
        /* --- 1. åŸºç¡€æ ·å¼é‡ç½® --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f3f4f6; /* æµ…ç°èƒŒæ™¯ï¼Œä¿æŠ¤è§†åŠ› */
            color: #1f2937;
            line-height: 1.6;
        }

        /* --- 2. é¡¶éƒ¨å¯¼èˆªæ  --- */
        nav {
            background-color: #fff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .brand { font-size: 1.5rem; font-weight: bold; color: #3b82f6; }
        .user-info span { margin-right: 15px; color: #6b7280; }
        .btn-logout {
            color: #ef4444;
            text-decoration: none;
            font-size: 0.9rem;
            cursor: pointer;
        }

        /* --- 3. ä¸»ä½“å®¹å™¨ --- */
        .container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        /* --- 4. å‘å¸ƒæ¡†å¡ç‰‡ --- */
        .card {
            background: #fff;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
            transition: transform 0.2s;
        }
        .input-group textarea {
            width: 100%;
            height: 100px;
            padding: 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            resize: none;
            font-size: 1rem;
            margin-bottom: 1rem;
            outline: none;
        }
        .input-group textarea:focus { border-color: #3b82f6; box-shadow: 0 0 0 2px #93c5fd; }

        .btn-primary {
            background-color: #3b82f6;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            float: right;
        }
        .btn-primary:hover { background-color: #2563eb; }
        .clearfix::after { content: ""; display: table; clear: both; }

        /* --- 5. ç•™è¨€åˆ—è¡¨ --- */
        .message-item {
            border-bottom: 1px solid #f3f4f6;
            padding: 1.5rem 0;
            display: flex;
            gap: 15px;
        }
        .avatar {
            width: 45px;
            height: 45px;
            background-color: #dbeafe;
            color: #1e40af;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
            flex-shrink: 0;
        }
        .msg-content { flex-grow: 1; }
        .msg-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        .username { font-weight: bold; color: #374151; }
        .time { color: #9ca3af; font-size: 0.85rem; }
        .msg-body { color: #4b5563; white-space: pre-wrap; /* ä¿ç•™æ¢è¡Œ */ }

        /* --- 6. åˆ†é¡µæŒ‰é’® --- */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 2rem;
            margin-bottom: 3rem;
        }
        .page-btn {
            background: #fff;
            border: 1px solid #e5e7eb;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            color: #374151;
        }
        .page-btn:disabled { background: #f3f4f6; color: #ccc; cursor: not-allowed; }
        .page-info { display: flex; align-items: center; color: #6b7280; font-size: 0.9rem;}
    </style>
</head>
<body>

<h2>ç•™è¨€æ¿</h2>

<button onclick="add()">å‘å¸ƒ</button>

<hr>

<nav>
    <div class="brand">ğŸ’¬ æ ‘æ´ç•™è¨€æ¿</div>
    <div class="user-info">
        <span id="current-user">æ­£åœ¨è·å–ç”¨æˆ·ä¿¡æ¯...</span>
        <a onclick="logout()" class="btn-logout">é€€å‡ºç™»å½•</a>
    </div>
</nav>

<div class="container">
    <div class="card clearfix">
        <div class="input-group">
            <label for="content">å†…å®¹</label>
            <textarea id="content" placeholder="è¯´è¯ï¼ï¼ï¼ï¼åˆ†äº«ä½ çš„æ–°é²œäº‹... (æ”¯æŒè¡¨æƒ… âœ¨)"></textarea>
        </div>
        <button class="btn-primary" onclick="add()">å‘å¸ƒç•™è¨€</button>
    </div>

    <div class="card" style="padding-top: 0;">
        <div id="list">
            <div style="text-align: center; padding: 20px; color: #999;">åŠ è½½ä¸­...</div>
        </div>
    </div>

    <div class="pagination">
        <button class="page-btn" onclick="changePage(-1)" id="btn-prev">ä¸Šä¸€é¡µ</button>
        <span class="page-info">ç¬¬ <span id="curr-page">1</span> / <span id="total-pages">1</span> é¡µ</span>
        <button class="page-btn" onclick="changePage(1)" id="btn-next">ä¸‹ä¸€é¡µ</button>
    </div>
</div>

<script>
    // å…¨å±€åˆ†é¡µå˜é‡
    let currentPage = 1;
    let pageSize = 5;
    let totalPages = 1;

    // é¡µé¢åŠ è½½å®Œæ¯•åç«‹å³æ‰§è¡Œ
    window.onload = function() {
        checkLogin();
        loadMessages();
    };

    // 1. æ£€æŸ¥æ˜¯å¦ç™»å½• (å¯é€‰ï¼Œä¸ºäº†æ˜¾ç¤ºç”¨æˆ·å)
    function checkLogin() {
        // è¿™é‡Œç®€å•æ¨¡æ‹Ÿï¼Œå®é™…ä¸Šä½ å¯ä»¥å†™ä¸€ä¸ªæ¥å£ /user/current æ¥è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
        // å¦‚æœåç«¯ Session é‡Œæœ‰ loginUserï¼Œä½ å¯ä»¥é€šè¿‡é¡µé¢æ¸²æŸ“æˆ–è€… fetch è·å–
        document.getElementById('current-user').innerText = "æ¬¢è¿å›æ¥";
    }

    // 2. åŠ è½½ç•™è¨€åˆ—è¡¨ (æ ¸å¿ƒ)
    function loadMessages() {
        fetch(`/message/list?page=${currentPage}&size=${pageSize}`,{
            method: 'GET',
            headers:{
                'token': localStorage.getItem("token")
            }
        })
            .then(res => res.json())
            .then(res => {
                if(res.code === 200) {
                    const pageData = res.data;
                    renderList(pageData.records);
                    updatePagination(pageData);
                } else {
                    alert("åŠ è½½å¤±è´¥ï¼š" + res.message);
                }
            })
            .catch(err => console.error(err));
    }

    // 3. æ¸²æŸ“ HTML
    function renderList(messages) {
        const listDiv = document.getElementById('list');
        listDiv.innerHTML = ''; // æ¸…ç©ºæ—§æ•°æ®

        if(!messages || messages.length === 0) {
            listDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: #ccc;">æš‚æ—¶è¿˜æ²¡æœ‰ç•™è¨€ï¼Œå¿«æ¥æŠ¢æ²™å‘ï¼</div>';
            return;
        }

        messages.forEach(m => {
            // æå–ç”¨æˆ·åçš„é¦–å­—æ¯ä½œä¸ºå¤´åƒ
            const firstChar = m.username ? m.username.charAt(0).toUpperCase() : 'U';

            // è¿™é‡Œçš„å­—æ®µåå¿…é¡»å’Œä½ çš„ MessageVO ä¿æŒä¸€è‡´ï¼
            const itemHtml = `
                    <div class="message-item">
                        <div class="avatar">${firstChar}</div>
                        <div class="msg-content">
                            <div class="msg-header">
                                <span class="username">${m.username || 'åŒ¿åç”¨æˆ·'}</span>
                                <span class="time">${formatDate(m.createTime)}</span>
                            </div>
                            <div class="msg-body">${m.content}</div>
                        </div>
                    </div>
                `;
            listDiv.innerHTML += itemHtml;
        });
    }

    // 4. æ›´æ–°åˆ†é¡µæŒ‰é’®çŠ¶æ€
    function updatePagination(pageData) {
        totalPages = pageData.pages; // åç«¯ MyBatis-Plus è¿”å›çš„æ€»é¡µæ•°
        document.getElementById('curr-page').innerText = currentPage;
        document.getElementById('total-pages').innerText = totalPages;

        document.getElementById('btn-prev').disabled = (currentPage === 1);
        document.getElementById('btn-next').disabled = (currentPage >= totalPages);
    }

    // 5. ç¿»é¡µé€»è¾‘
    function changePage(step) {
        const newPage = currentPage + step;
        if(newPage > 0 && newPage <= totalPages) {
            currentPage = newPage;
            loadMessages();
        }
    }

    // 6. å‘å¸ƒç•™è¨€
    function add() {
        const content = document.getElementById('content').value;
        if(!content.trim()) {
            alert("å†™ç‚¹ä»€ä¹ˆå†å‘å¸ƒå§ï¼");
            return;
        }

        fetch('/message/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'token': localStorage.getItem("token")
            },
            body: JSON.stringify({ content: content })
        })
            .then(res => res.json())
            .then(data => {
                if(data.code === 200) {
                    document.getElementById('content').value = ''; // æ¸…ç©ºè¾“å…¥æ¡†
                    currentPage = 1; // å‘å¸ƒåè·³å›ç¬¬ä¸€é¡µçœ‹æœ€æ–°æ¶ˆæ¯
                    loadMessages();  // é‡æ–°åŠ è½½åˆ—è¡¨
                } else {
                    alert("å‘å¸ƒå¤±è´¥ï¼š" + data.message);
                }
            });
    }

    // 7. é€€å‡ºç™»å½•
    function logout() {
        // è¿™é‡Œä½ å¯ä»¥è°ƒç”¨åç«¯çš„ /logout æ¥å£ï¼Œæˆ–è€…ç›´æ¥åˆ é™¤ Cookie
        localStorage.removeItem("token"); //æ¸…é™¤ Token é€€å‡º
        window.location.href = '/login.html';

    }

    // å·¥å…·ï¼šæ ¼å¼åŒ–æ—¶é—´ (æŠŠ 2026-01-19T18:00... å˜æˆ 2026/01/19 18:00)
    function formatDate(dateString) {
        if(!dateString) return '';
        const date = new Date(dateString);
        return date.toLocaleString();
    }


</script>

</body>
</html>